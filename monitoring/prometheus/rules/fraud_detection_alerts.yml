# Fraud Detection Specific Alerting Rules
groups:
  - name: fraud_detection_alerts
    interval: 30s
    rules:
      # High Fraud Rate Alert
      - alert: HighFraudRate
        expr: (rate(fraud_detection_decisions_total{decision="block"}[5m]) / rate(fraud_detection_decisions_total[5m])) > 0.1
        for: 2m
        labels:
          severity: warning
          service: fraud-detection
          category: business
        annotations:
          summary: "High fraud detection rate observed"
          description: "Fraud rate is {{ printf \"%.2f\"  }}% over the last 5 minutes, which is above the 10% threshold"
          runbook_url: "https://docs.company.com/runbooks/high-fraud-rate"
          
      # Critical Fraud Rate Alert
      - alert: CriticalFraudRate
        expr: (rate(fraud_detection_decisions_total{decision="block"}[5m]) / rate(fraud_detection_decisions_total[5m])) > 0.25
        for: 1m
        labels:
          severity: critical
          service: fraud-detection
          category: business
        annotations:
          summary: "Critical fraud detection rate observed"
          description: "Fraud rate is {{ printf \"%.2f\"  }}% over the last 5 minutes, indicating possible attack"
          
      # Model Performance Degradation
      - alert: ModelPerformanceDegradation
        expr: fraud_detection_model_accuracy < 0.9
        for: 5m
        labels:
          severity: warning
          service: fraud-detection
          category: model
        annotations:
          summary: "ML model accuracy has degraded"
          description: "Model accuracy is {{ printf \"%.3f\"  }}, below acceptable threshold of 0.9"
          
      # High False Positive Rate
      - alert: HighFalsePositiveRate
        expr: (rate(fraud_detection_false_positives_total[10m]) / rate(fraud_detection_decisions_total{decision="block"}[10m])) > 0.05
        for: 5m
        labels:
          severity: warning
          service: fraud-detection
          category: model
        annotations:
          summary: "High false positive rate detected"
          description: "False positive rate is {{ printf \"%.3f\"  }}, above 5% threshold"
          
      # Model Inference Latency
      - alert: HighModelInferenceLatency
        expr: histogram_quantile(0.95, rate(fraud_detection_inference_duration_seconds_bucket[5m])) > 0.1
        for: 3m
        labels:
          severity: warning
          service: fraud-detection
          category: performance
        annotations:
          summary: "High model inference latency"
          description: "95th percentile inference latency is {{ printf \"%.3f\"  }}s, above 100ms threshold"
          
      # Transaction Processing Rate Drop
      - alert: LowTransactionProcessingRate
        expr: rate(fraud_detection_transactions_processed_total[5m]) < 100
        for: 5m
        labels:
          severity: warning
          service: fraud-detection
          category: performance
        annotations:
          summary: "Low transaction processing rate"
          description: "Processing only {{ printf \"%.1f\"  }} transactions per second"
          
      # Model Drift Detection
      - alert: ModelDriftDetected
        expr: fraud_detection_model_drift_score > 0.3
        for: 10m
        labels:
          severity: warning
          service: fraud-detection
          category: model
        annotations:
          summary: "Model drift detected"
          description: "Model drift score is {{ printf \"%.3f\"  }}, indicating data distribution change"
          
      # Feature Store Unavailable
      - alert: FeatureStoreUnavailable
        expr: up{job="feature-store"} == 0
        for: 1m
        labels:
          severity: critical
          service: fraud-detection
          category: infrastructure
        annotations:
          summary: "Feature store is unavailable"
          description: "Feature store has been unavailable for {{  }} minutes"
          
      # Alert Queue Backlog
      - alert: AlertQueueBacklog
        expr: fraud_detection_alert_queue_size > 1000
        for: 5m
        labels:
          severity: warning
          service: fraud-detection
          category: operational
        annotations:
          summary: "Large alert queue backlog"
          description: "Alert queue has {{  }} pending alerts"
          
      # Blacklist Check Failures
      - alert: BlacklistCheckFailures
        expr: rate(fraud_detection_blacklist_check_failures_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          service: fraud-detection
          category: infrastructure
        annotations:
          summary: "Blacklist check failures detected"
          description: "{{ printf \"%.2f\"  }} blacklist check failures per second"

  - name: fraud_detection_business_metrics
    interval: 1m
    rules:
      # Daily Fraud Prevention Amount
      - record: fraud_detection:daily_prevented_amount
        expr: increase(fraud_detection_prevented_fraud_amount_total[24h])
        
      # Hourly Transaction Volume
      - record: fraud_detection:hourly_transaction_volume
        expr: increase(fraud_detection_transactions_processed_total[1h])
        
      # Model Efficiency Score
      - record: fraud_detection:model_efficiency_score
        expr: (fraud_detection_model_accuracy * fraud_detection_model_precision * fraud_detection_model_recall) ^ (1/3)
        
      # Risk Distribution
      - record: fraud_detection:risk_distribution
        expr: rate(fraud_detection_risk_level_total[5m]) by (risk_level)
        
      # Geographic Fraud Distribution
      - record: fraud_detection:geo_fraud_rate
        expr: (rate(fraud_detection_decisions_total{decision="block"}[1h]) / rate(fraud_detection_transactions_processed_total[1h])) by (country)
