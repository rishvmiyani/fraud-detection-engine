name: 🔒 Security Scanning

on:
  schedule:
    - cron: '0 3 * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'

jobs:
  # 🔍 Dependency Security Scan
  dependency-scan:
    name: 🔍 Dependency Security
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 📦 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: 🔍 Safety Check
        run: |
          mkdir -p reports
          safety check --json --output reports/safety-report.json || true
          safety check --short-report || true
        continue-on-error: true
      
      - name: 🔍 Bandit Security Scan
        run: |
          bandit -r . -f json -o reports/bandit-report.json || true
          bandit -r . -ll || true
        continue-on-error: true
      
      - name: 📊 Upload Security Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: reports/

  # 🐳 Container Security
  container-scan:
    name: 🐳 Container Security
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
      
      - name: 🐳 Build Test Image
        run: |
          echo "FROM python:3.12-slim" > Dockerfile
          echo "WORKDIR /app" >> Dockerfile
          echo "COPY requirements.txt ." >> Dockerfile
          echo "RUN pip install -r requirements.txt || true" >> Dockerfile
          echo "COPY . ." >> Dockerfile
          echo 'CMD ["python", "-c", "print(\"Hello World\")"]' >> Dockerfile
          docker build -t security-test:latest .
      
      - name: 🔍 Trivy Container Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'security-test:latest'
          format: 'table'
          exit-code: '0'

  # 🔒 Secrets Detection
  secrets-scan:
    name: 🔒 Secrets Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 🔍 GitLeaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 📊 Security Report
  security-report:
    name: 📊 Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, container-scan, secrets-scan]
    if: always()
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
      
      - name: 📥 Download Security Reports
        uses: actions/download-artifact@v3
        with:
          name: security-reports
          path: reports/
        continue-on-error: true
      
      - name: 📊 Generate Security Summary
        run: |
          echo "# 🔒 Security Scan Report" > security-summary.md
          echo "" >> security-summary.md
          echo "## 📊 Scan Results" >> security-summary.md
          echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> security-summary.md
          echo "- Container Scan: ${{ needs.container-scan.result }}" >> security-summary.md
          echo "- Secrets Scan: ${{ needs.secrets-scan.result }}" >> security-summary.md
          echo "" >> security-summary.md
          echo "**Date:** $(date)" >> security-summary.md
      
      - name: 📱 Security Notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "🔒 Security Scan Completed",
              "attachments": [{
                "color": "${{ contains(needs.*.result, 'failure') && 'danger' || 'good' }}",
                "fields": [{
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                }, {
                  "title": "Branch",
                  "value": "${{ github.ref_name }}",
                  "short": true
                }, {
                  "title": "Status",
                  "value": "${{ contains(needs.*.result, 'failure') && '❌ Issues Found' || '✅ Clean' }}",
                  "short": true
                }]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
